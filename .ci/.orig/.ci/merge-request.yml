.merge request:
  stage: merge request
  before_script:
    - export HOST=${CI_PROJECT_URL}
    - export CI_PROJECT_ID=${CI_PROJECT_ID}
    - export GITLAB_USER_ID=${GITLAB_USER_ID}
    - export PRIVATE_TOKEN=${PRIVATE_TOKEN}
  except:
    - schedules

wip merge:
  extends: .merge request
  script:
    - ${SCRIPTS}/merge-request.sh wip-devel delete squash
  only:
    - /^devel.+$/

devel merge:
  extends: .merge request
  script:
    - "export WIP_STATUS='WIP: '"
    - if git log -1 --pretty=%B | grep "<<push" > /dev/null; then
    -   echo "В последнем коммите флаг '<<push' - делаем push вместо merge request'a"
    -   if git push ${PROJECT_SSH} HEAD:refs/heads/devel; then
    -     exit 0
    -   else
    -     echo "Не удалось сделать авто push, делаем merge request"
    -   fi
    - fi
    - ${SCRIPTS}/merge-request.sh devel
  only:
    - wip-devel


make pre-release:
  stage: merge request
  script:
    - git branch -a
    - git push -f ${PROJECT_SSH} HEAD:refs/heads/pre-release
  only:
    - devel

master merge:
  extends: .merge request
  script:
    - if [[ "${ALLOW_AHEAD_MASTER}" != "ON" ]]; then ${SCRIPTS}/masterchef.sh; fi
    - if git log -1 --pretty=%B | grep "<<push" > /dev/null; then
    -   echo "В последнем коммите флаг '<<push' - делаем push вместо merge request'a"
    -   if git push ${PROJECT_SSH} HEAD:refs/heads/master; then
    -     exit 0
    -   else
    -     echo "Не удалось сделать авто push, делаем merge request"
    -   fi
    - fi
    - ${SCRIPTS}/merge-request.sh master delete
  only:
    - pre-release
    - hotfix

make release:
  extends: .merge request
  script:
    - git tag -f -a ${RELEASE_TAG} -m "${RELEASE_BRANCH}"
    - git push --force ${PROJECT_SSH} ${CI_COMMIT_REF_NAME}:${RELEASE_BRANCH}
    - git push --tags --force ${PROJECT_SSH} ${CI_COMMIT_REF_NAME}:${RELEASE_BRANCH}
    - if [ -n "${NEXT_PROJECT}" ]; then
    -   git clone git@github.lan:${NEXT_PROJECT}.git _next_project_
    -   pushd _next_project_
    -     git checkout wip-devel
    -     echo Удаляем бранч auto-build, чтобы гарантированно запушить
    -     echo git push --delete git@github.lan:${NEXT_PROJECT}.git auto-build || true
    -     git push --delete git@github.lan:${NEXT_PROJECT}.git auto-build || true
    -     echo git push -f git@github.lan:${NEXT_PROJECT}.git wip-devel:auto-build
    -     git push -f git@github.lan:${NEXT_PROJECT}.git wip-devel:auto-build
    -   popd
    -   rm -rf _next_project_
    - fi
  only:
    - master
